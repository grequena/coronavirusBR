---
title: "Coronavírus"
output: 
  flexdashboard::flex_dashboard:
   source_code: embed
   vertical_layout: scroll
runtime: shiny
---


```{r first, include=FALSE}
#------------------ Packages ------------------
suppressWarnings(suppressMessages(library(flexdashboard)))
suppressWarnings(suppressMessages(library(shiny)))

#------------------ Parameters ------------------
# set colors
confirmed_color <- rgb(20, 120, 190, maxColorValue = 255)
death_color <- rgb(220, 40, 40, maxColorValue = 255, alpha = 230)
recovered_color <- rgb(10, 120, 10, maxColorValue = 255, alpha = 230)

`%>%` <- magrittr::`%>%` 
#------------------ Data 1 ------------------
# install.packages("devtools")
# devtools::install_github("RamiKrispin/coronavirus")
# coronavirus::update_datasets(silence = TRUE)
# library(coronavirus)
# data(coronavirus)
# max(coronavirus$date)
#------------------ Data 2 (John Hopkins) cumuled ------------------
# confirmed cases in wide format
d.con <- read.csv(url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv"))
# recovered
d.rec <- read.csv(url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv"))
# death
d.dea <- read.csv(url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv"))
# confirmed cases in long format
d.con.long <- reshape(data      = d.con,
                      varying   = names(d.con)[5:ncol(d.con)],
                      v.names   = 'cases',
                      times     = names(d.con)[5:ncol(d.con)],
                      direction = 'long') %>% 
  dplyr::mutate(date = 
                  lubridate::mdy(stringr::str_replace_all(time, 'X', '')),
                type = rep('confirmed', (ncol(d.con)-4)*nrow(d.con))) %>% 
  dplyr::select(1, 2, 3, 4, 6, 7, 8, 9)
# recovered
d.rec.long <- reshape(data      = d.rec,
                      varying   = names(d.rec)[5:ncol(d.rec)],
                      v.names   = 'cases',
                      times     = names(d.rec)[5:ncol(d.rec)],
                      direction = 'long') %>% 
  dplyr::mutate(date = 
                  lubridate::mdy(stringr::str_replace_all(time, 'X', '')),
                type = rep('recovered', (ncol(d.rec)-4)*nrow(d.rec))) %>% 
  dplyr::select(1, 2, 3, 4, 6, 7, 8, 9)
# death
d.dea.long <- reshape(data      = d.dea,
                      varying   = names(d.dea)[5:ncol(d.dea)],
                      v.names   = 'cases',
                      times     = names(d.dea)[5:ncol(d.dea)],
                      direction = 'long') %>% 
  dplyr::mutate(date = 
                  lubridate::mdy(stringr::str_replace_all(time, 'X', '')),
                type = rep('death', (ncol(d.dea)-4)*nrow(d.dea))) %>% 
  dplyr::select(1, 2, 3, 4, 6, 7, 8, 9)
# cumuled final data long
covid.cum <- rbind(d.con.long, 
                   d.rec.long, 
                   d.dea.long)
#------------------ Data 3 (John Hopkins) daily ------------------
d.con.daily <- cbind(d.con[, 1:5], # first day, today - yesterday
                     d.con[, 6:ncol(d.con)] - d.con[, 5:(ncol(d.con)-1)])
d.rec.daily <- cbind(d.rec[, 1:5], 
                     d.rec[, 6:ncol(d.rec)] - d.rec[, 5:(ncol(d.rec)-1)])
d.dea.daily <- cbind(d.dea[, 1:5], 
                     d.dea[, 6:ncol(d.dea)] - d.dea[, 5:(ncol(d.dea)-1)])
# confirmed cases in long format
d.con.daily.l <- reshape(data      = d.con.daily,
                         varying   = names(d.con.daily)[5:ncol(d.con.daily)],
                         v.names   = 'cases',
                         times     = names(d.con.daily)[5:ncol(d.con.daily)],
                         direction = 'long') %>% 
  dplyr::mutate(date = 
                  lubridate::mdy(stringr::str_replace_all(time, 'X', '')),
                type = rep('confirmed', (ncol(d.con.daily)-4)*nrow(d.con.daily))) %>%
  dplyr::select(1, 2, 3, 4, 6, 7, 8, 9)
# recovered
d.rec.daily.l <- reshape(data      = d.rec.daily,
                         varying   = names(d.rec.daily)[5:ncol(d.rec.daily)],
                         v.names   = 'cases',
                         times     = names(d.rec.daily)[5:ncol(d.rec.daily)],
                         direction = 'long') %>% 
  dplyr::mutate(date = 
                  lubridate::mdy(stringr::str_replace_all(time, 'X', '')),
                type = rep('recovered', (ncol(d.rec.daily)-4)*nrow(d.rec.daily))) %>%
  dplyr::select(1, 2, 3, 4, 6, 7, 8, 9)
# death
d.dea.daily.l <- reshape(data      = d.dea.daily,
                         varying   = names(d.dea.daily)[5:ncol(d.dea.daily)],
                         v.names   = 'cases',
                         times     = names(d.dea.daily)[5:ncol(d.dea.daily)],
                         direction = 'long') %>% 
  dplyr::mutate(date = 
                  lubridate::mdy(stringr::str_replace_all(time, 'X', '')),
                type = rep('death', (ncol(d.dea.daily)-4)*nrow(d.dea.daily))) %>% 
  dplyr::select(1, 2, 3, 4, 6, 7, 8, 9)
# daily final data long
coronavirus <- rbind(d.con.daily.l,
                     d.rec.daily.l,
                     d.dea.daily.l)
# max(coronavirus$date)

```


<!-- --------------------------------------- -->
<!-- ---------- Data manipulation ---------- -->
<!-- --------------------------------------- -->


```{r data mani, include = F}
#------------------ Brazil ------------------
# total
dfBR <- coronavirus %>%
  dplyr::filter(Country.Region == "Brazil") %>%
  dplyr::group_by(Country.Region, type) %>%
  dplyr::summarise(total = sum(cases)) %>%
  tidyr::pivot_wider(names_from = type,
                     values_from = total)
# daily
df_dailyBR <- coronavirus %>%
  dplyr::filter(Country.Region == "Brazil") %>%
  dplyr::group_by(date, type) %>%
  dplyr::summarise(total = sum(cases, na.rm = TRUE)) %>%
  tidyr::pivot_wider(names_from = type,
                     values_from = total) %>%
  dplyr::arrange(date) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(confirmed_cum = cumsum(confirmed),
                death_cum = cumsum(death),
                recovered_cum = cumsum(recovered))

#------------------ World ------------------
df <- coronavirus %>%
  dplyr::group_by(Country.Region, type) %>%
  dplyr::summarise(total = sum(cases)) %>%
  tidyr::pivot_wider(names_from = type,
                     values_from = total) %>%
  dplyr::arrange(-confirmed)

df_daily <- coronavirus %>%
  dplyr::group_by(date, type) %>%
  dplyr::summarise(total = sum(cases, na.rm = TRUE)) %>%
  tidyr::pivot_wider(names_from = type,
                     values_from = total) %>%
  dplyr::arrange(date) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(confirmed_cum = cumsum(confirmed),
                death_cum = cumsum(death),
                recovered_cum = cumsum(recovered))

df_pais <- coronavirus %>%
  dplyr::group_by(date, type, Country.Region) %>%
  dplyr::summarise(total = sum(cases, na.rm = TRUE)) %>%
  tidyr::pivot_wider(names_from = type,
                     values_from = total) %>%
  dplyr::arrange(date) %>%
  dplyr::group_by(Country.Region) %>%
  dplyr::mutate(confirmed_cum = cumsum(confirmed),
                death_cum = cumsum(death),
                recovered_cum = cumsum(recovered))
```





Resumo
=======================================================================


<!-- ----------------------------------- -->
<!-- ---------- Boxes BRASIL  ---------- -->
<!-- ----------------------------------- -->


Column {data-width=500}
-------------------------------------

### confirmed {.value-box}

```{r box conf br}
flexdashboard::valueBox(
  value = format(dfBR$confirmed, big.mark = ".", decimal.mark = ","),
  caption = paste("Confirmados no <B>BRASIL</B> • ",
                  as.character.POSIXt(max(coronavirus$date), 
                                      format = "%d/%m/%Y")), 
  icon = "fas fa-diagnoses",
  color = confirmed_color
)
```



### recovered {.value-box}

```{r box recov br}
flexdashboard::valueBox(
  value = paste(format(dfBR$recovered, big.mark = ".", decimal.mark = ","), 
                " (",
                format(round(100 * (dfBR$recovered / dfBR$confirmed), 1),
                       big.mark = ".", decimal.mark = ","), 
                "%)", sep = ""),
  caption = "Recuperados no <B>BRASIL</B>",
  icon = "fas fa-user-check",
  color = recovered_color
)
```

### death {.value-box}

```{r box death br}
flexdashboard::valueBox(
  value = paste(format(dfBR$death, big.mark = ".", decimal.mark = ","), 
                " (",
                format(round(100 * (dfBR$death / dfBR$confirmed), 1),
                       big.mark = ".", decimal.mark = ","), 
                "%)", sep = ""),
  caption = "Mortes no <B>BRASIL</B>",
  icon = "fas fa-user-times",
  color = death_color
)
```


<!-- ------------------------------------------------------------- -->
<!-- ---------- Chart Confirmed x Recov x Deaths BRASIL ---------- -->
<!-- ------------------------------------------------------------- -->


### **Evolução no BRASIL desde 25/02/2020**

```{r chart evolucao br}
plotly::plot_ly(data = df_dailyBR %>% 
  dplyr::filter(date > "2020-02-24")) %>%
  plotly::add_trace(x = ~date,
                    y = ~confirmed_cum,
                    type = "scatter",
                    mode = "lines+markers",
                    name = "Confirmados",
                    line = list(color = confirmed_color),
                    marker = list(color = confirmed_color)) %>%
  plotly::add_trace(x = ~date,
                    y = ~recovered_cum,
                    type = "scatter",
                    mode = "lines+markers",
                    name = "Recuperados",
                    opacity = 0.85,
                    line = list(color = recovered_color),
                    marker = list(color = recovered_color)) %>%
  plotly::add_trace(x = ~date,
                    y = ~death_cum,
                    type = "scatter",
                    mode = "lines+markers",
                    name = "Mortes",
                    opacity = 0.85,
                    line = list(color = death_color),
                    marker = list(color = death_color)) %>%
  plotly::add_annotations(x = as.Date("2020-02-26"),
                          y = 1,
                          text = paste("Primeiro caso"),
                          xref = "x",
                          yref = "y",
                          arrowhead = 5,
                          arrowhead = 5,
                          arrowsize = 1,
                          showarrow = TRUE,
                          ax = 0,
                          ay = -90) %>%
  plotly::add_annotations(x = as.Date("2020-03-17"),
                          y = 3,
                          text = paste("Primeira morte"),
                          xref = "x",
                          yref = "y",
                          arrowhead = 5,
                          arrowhead = 3,
                          arrowsize = 1,
                          showarrow = TRUE,
                          ax = 0,
                          ay = -90) %>%
  plotly::layout(title = "",
                 yaxis = list(title = "Frequência acumulada de casos"),
                 xaxis = list(title = ""),
                 legend = list(x = 0.1, y = 0.9),
                 hovermode = "compare")
```


### **Casos diários no BRASIL desde 25/02/2020**

```{r chart daily br}
plotly::plot_ly(data = df_dailyBR %>% 
  dplyr::filter(date > "2020-02-24"), 
                x = ~ date, 
                y = ~ confirmed, 
                type = "bar", 
                name = "Confirmados",
                marker = list(color = confirmed_color)) %>%
  plotly::add_trace(y = ~ recovered, 
                    name = "Recuperados",
                    marker = list(color = recovered_color)) %>%
  plotly::add_trace(y = ~ death, 
                    name = "Mortes",
                    marker = list(color = death_color)) %>%
  plotly::layout(barmode = 'overlay',
                 yaxis = list(title = "Número de casos"),
                 xaxis = list(title = ""),
                 legend = list(x = 0.1, y = 0.9),
                 hovermode = "compare")
```



<!-- ------------------------------- --> 
<!-- ---------- Box  WORLD --------- -->
<!-- ------------------------------- -->


Column {data-width=500}
-------------------------------------

### confirmed {.value-box}

```{r box conf}
flexdashboard::valueBox(
  value = paste(format(sum(df$confirmed), big.mark = ".", decimal.mark = ",")),
  caption = paste("Confirmados no <B>MUNDO</B> • ",
                  as.character.POSIXt(max(coronavirus$date),
                                      format = "%d/%m/%Y")),
  icon = "fas fa-diagnoses",
  color = confirmed_color
)
```



### recovered {.value-box}

```{r box recov}
flexdashboard::valueBox(
  value = paste(format(sum(df$recovered, na.rm = TRUE),
                       big.mark = ".", decimal.mark = ","),
                " (", format(round(100 * sum(df$recovered, na.rm = TRUE) /
                                     sum(df$confirmed), 1),
                             big.mark = ".", decimal.mark = ","),
                "%)", sep = ""),
  caption = "Recuperados no <B>MUNDO</B>",
  icon = "fas fa-user-check",
  color = recovered_color
)
```

### death {.value-box}

```{r box death}
flexdashboard::valueBox(
  value = paste(format(sum(df$death, na.rm = TRUE),
                       big.mark = ".", decimal.mark = ","),
                " (", format(round(100 * sum(df$death, na.rm = TRUE) /
                                     sum(df$confirmed), 1),
                             big.mark = ".", decimal.mark = ","),
                "%)", sep = ""),
  caption = "Mortes no <B>MUNDO</B>",
  icon = "fas fa-user-times",
  color = death_color
)
```



<!-- ---------------------------------------------------- -->
<!-- ---------- Chart Confirmed x Deaths WORLD ---------- -->
<!-- ---------------------------------------------------- -->


### **Evolução no MUNDO desde 22/01/2020**

```{r chart evolucao}
plotly::plot_ly(data = df_daily) %>%
  plotly::add_trace(x = ~date,
                    y = ~confirmed_cum,
                    type = "scatter",
                    mode = "lines+markers",
                    name = "Confirmados",
                    marker = list(color = confirmed_color, 
                                  symbol = 'circle'),
                    line = list(color = confirmed_color)) %>%
  plotly::add_trace(x = ~date,
                    y = ~recovered_cum,
                    type = "scatter",
                    mode = "lines+markers",
                    name = "Recuperados",
                    opacity = 0.85,
                    line = list(color = recovered_color),
                    marker = list(color = recovered_color)) %>%
  plotly::add_trace(x = ~date,
                    y = ~death_cum,
                    type = "scatter",
                    mode = "lines+markers",
                    name = "Mortes",
                    opacity = 0.85,
                    line = list(color = death_color),
                    marker = list(color = death_color)) %>%
  plotly::layout(title = "",
                 yaxis = list(title = "Número de casos acumulado"),
                 xaxis = list(title = ""),
                 legend = list(x = 0.1, y = 0.9),
                 hovermode = "compare")
```


### **Casos diários no MUNDO desde 22/01/2020**

```{r chart daily}
plotly::plot_ly(data = df_daily, 
                x = ~ date, 
                y = ~ confirmed, 
                type = "bar", 
                name = "Confirmados",
                marker = list(color = confirmed_color)) %>%
  plotly::add_trace(y = ~ recovered, 
                    name = "Recuperados",
                    marker = list(color = recovered_color)) %>%
  plotly::add_trace(y = ~ death, 
                    name = "Mortes",
                    marker = list(color = death_color)) %>%
  plotly::layout(barmode = 'overlay',
                 yaxis = list(title = "Número de casos"),
                 xaxis = list(title = ""),
                 legend = list(x = 0.1, y = 0.9),
                 hovermode = "compare")
```



Compare
=====================================================================

Inputs {.sidebar}
---------------------------------------------

###

```{r comparacao}
shiny::selectInput("country", "País/Região:",
                   choices = c("Mundo", as.character(df$Country.Region)),
                   selected = c("Brazil", as.character(df$Country.Region[1])),
                   multiple = T, width = "100%")

shiny::selectInput("type", "Tipo:",
                   choices = c("Confirmados", "Recuperados", "Mortes"),
                   selected = "Confirmados", multiple = F, width = "100%")

# shinyselectedData <- reactive({
#   coronavirus %>%
#     dplyr::filter(Country.Region %in% input$country) %>%
#     dplyr::group_by(date, type, Country.Region) %>%
#     dplyr::summarise(total = sum(cases, na.rm = TRUE)) %>%
#     tidyr::pivot_wider(names_from = type,
#                        values_from = total) %>%
#     dplyr::arrange(date) %>%
#     dplyr::group_by(Country.Region) %>%
#     dplyr::dplyr::mutate(confirmed_cum = cumsum(confirmed),
#                   death_cum = cumsum(death),
#                   recovered_cum = cumsum(recovered))
# })
```


Column {data-width=500}
-------------------------------------

### **Evolução dos casos desde `r as.character.POSIXt(max(coronavirus$date), format = "%d/%m/%Y")`**

```{r chart comparacao conf}
plotly::renderPlotly({
  fig <- plotly::plot_ly()
  n <- length(input$country)
  cores <- c("#008000", "#1981CD", "#FFBF00", "#000000", "#00CED1",
             "#DE3163", "#FF7F50", "#A2006D", "#8EE53F", "#556B2F",
             "#9400D3", "#00FA9A", "#EE82EE", "#8FBC8F", "#800000")
  
  for(i in 1:n) {
    aux.df <- df_pais %>%
      filter(Country.Region == input$country[i])
    if(input$type == "Confirmados") {
      fig <- plotly::add_trace(fig,
                               data = aux.df,
                               x = ~date,
                               y = ~confirmed_cum,
                               type = "scatter",
                               mode = "lines+markers",
                               name = input$country[i],
                               showlegend = F,
                               marker = list(color = cores[i]),
                               line = list(color = cores[i],
                                           width = 1))
    }
    if(input$type == "Recuperados") {
      fig <- plotly::add_trace(fig,
                               data = aux.df,
                               x = ~date,
                               y = ~recovered_cum,
                               type = "scatter",
                               mode = "lines+markers",
                               name = input$country[i],
                               showlegend = F,
                               marker = list(color = cores[i]),
                               line = list(color = cores[i],
                                           width = 1))
    }
    if(input$type == "Mortes") {
      fig <- plotly::add_trace(fig,
                               data = aux.df,
                               x = ~date,
                               y = ~death_cum,
                               type = "scatter",
                               mode = "lines+markers",
                               name = input$country[i],
                               showlegend = F,
                               marker = list(color = cores[i]),
                               line = list(color = cores[i],
                                           width = 1))
    }
  }
  fig <- plotly::layout(fig,
                        title = "",
                        yaxis = list(title = "Frequência acumulada"),
                        xaxis = list(title = ""),
                        legend = list(x = 0.1, y = 0.9),
                        hovermode = "compare"
  )
  fig
})
```





Mapa
=======================================================================

### **Mapa mundi**

```{r mapa}
library(leaflet)
library(leafpop)
library(purrr)
cv_data_for_plot <- coronavirus %>%
  dplyr::filter(cases > 0) %>%
  dplyr::group_by(Country.Region, Province.State, Lat, Long, type) %>%
  dplyr::summarise(cases = sum(cases)) %>%
  dplyr::mutate(log_cases = 2 * log(cases)) %>%
  dplyr::ungroup()
cv_data_for_plot.split <- cv_data_for_plot %>% split(cv_data_for_plot$type)
pal <- colorFactor(c("orange", "red", "green"), domain = c("confirmed", "death", "recovered"))
map_object <- leaflet() %>% addProviderTiles(providers$Stamen.Toner)
names(cv_data_for_plot.split) %>%
  purrr::walk(function(df) {
    map_object <<- map_object %>%
      addCircleMarkers(
        data = cv_data_for_plot.split[[df]],
        lng = ~Long, lat = ~Lat,
        #                 label=~as.character(cases),
        color = ~ pal(type),
        stroke = FALSE,
        fillOpacity = 0.8,
        radius = ~log_cases,
        popup = leafpop::popupTable(cv_data_for_plot.split[[df]],
                                    feature.id = FALSE,
                                    row.numbers = FALSE,
                                    zcol = c("type", "cases", "Country.Region", "Province.State")
        ),
        group = df,
        #                 clusterOptions = markerClusterOptions(removeOutsideVisibleBounds = F),
        labelOptions = labelOptions(
          noHide = F,
          direction = "auto"
        )
      )
  })
map_object %>%
  addLayersControl(
    overlayGroups = names(cv_data_for_plot.split),
    options = layersControlOptions(collapsed = FALSE)
  )
```











Sobre
=======================================================================

**Dashboard para acompanhamento dos casos de COVID-19 no Brasil**

Essa dashboard fornece uma descrição estatística sobre a evolução de casos do Novo Coronavírus (COVID-19) no Brasil e no mundo.

Sua construção foi feita no R através do R Markdown por meio do pacote [`flexdashboard`](https://rmarkdown.rstudio.com/flexdashboard/){target="_blank"} e o [`shiny`](https://shiny.rstudio.com/){target="_blank"}

Sua primeira versão é uma adaptação dessa [dashboard](https://ramikrispin.github.io/coronavirus_dashboard/){target="_blank"} por Rami Krispin.

**Código**

O código-fonte pode ser acessado no canto superior direito no botão `</> Source Code`.

**Dados**

Os bancos de dados utilizados são fornecidos pela Johns Hopkins University Center for Systems Science and Engineering (JHU CCSE), mantidos neste [repositório](https://github.com/CSSEGISandData/COVID-19) do github.

O portal oficial do Ministério da Saúde com os números de casos confirmados e óbitos no Brasil pode ser visto [aqui](https://covid.saude.gov.br/).


**Contato**

Para quaisquer dúvidas ou sugestões, você pode nos contatar através do e-mail requena@ufv.br.


**Atualização**

Última atualização:  `r as.character.POSIXt(Sys.time(), 
format = "%d/%m/%Y")`.
