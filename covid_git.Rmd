---
title: "Coronavírus"
output: 
  flexdashboard::flex_dashboard:
    theme: default
    css: style.css
    source_code: embed
    vertical_layout: scroll
markdown_extensions: 
    - admonition
editor_options: 
  chunk_output_type: console
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file, encoding=encoding,
  output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
---


```{r, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```


```{r, include=FALSE}
#_______________________________________________________________________________
#_______________________________________________________________________________
#---------------------------------------------------Loading package and data
#_______________________________________________________________________Packages
library(flexdashboard)
# library(tidyverse)
# library(shiny)
# library(plotly)
# library(countrycode)
# library(lubridate)
# library(dplyr)
# library(magrittr)
# library(hrbrthemes)
# library(viridis)
# library(ggplot2)
# library(ggiraph)
#_____________________________________________________________________Parameters
# - Set colors
confirmed_color <- rgb(20, 120, 190, maxColorValue = 255)
death_color     <- rgb(220, 40, 40,  maxColorValue = 255, alpha = 230)
recovered_color <- rgb(10, 120, 10,  maxColorValue = 255, alpha = 230)
confirmed_colorT <- rgb(20, 120, 190, maxColorValue = 255, alpha = 190)
death_colorT     <- rgb(220, 40, 40,  maxColorValue = 255, alpha = 190)
recovered_colorT <- rgb(10, 120, 10,  maxColorValue = 255, alpha = 190)
# - Use %>% directly
`%>%` <- magrittr::`%>%` 
#_________________________________________________________________________Data 1
# install.packages("devtools")
# devtools::install_github("RamiKrispin/coronavirus")
# coronavirus::update_datasets(silence = TRUE)
# library(coronavirus)
# data(coronavirus)
# max(coronavirus$date)
#______________________________________________________________Data 2 cumulative
# - Confirmed cases in wide format
d.con <- read.csv(url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv"))
# - Recovered
d.rec <- read.csv(url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv"))
# - Death
d.dea <- read.csv(url("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv"))
# - Confirmed cases in long format
d.con.long <- reshape(data      = d.con,
                      varying   = names(d.con)[5:ncol(d.con)],
                      v.names   = 'cases',
                      times     = names(d.con)[5:ncol(d.con)],
                      direction = 'long') %>% 
  dplyr::mutate(date = lubridate::mdy(stringr::str_replace_all(time, 'X', '')),
                type = rep('confirmed', (ncol(d.con)-4)*nrow(d.con))) %>% 
  dplyr::select(1, 2, 3, 4, 6, 7, 8, 9)
# - Recovered
d.rec.long <- reshape(data      = d.rec,
                      varying   = names(d.rec)[5:ncol(d.rec)],
                      v.names   = 'cases',
                      times     = names(d.rec)[5:ncol(d.rec)],
                      direction = 'long') %>% 
  dplyr::mutate(date = lubridate::mdy(stringr::str_replace_all(time, 'X', '')),
                type = rep('recovered', (ncol(d.rec)-4)*nrow(d.rec))) %>% 
  dplyr::select(1, 2, 3, 4, 6, 7, 8, 9)
# - Death
d.dea.long <- reshape(data      = d.dea,
                      varying   = names(d.dea)[5:ncol(d.dea)],
                      v.names   = 'cases',
                      times     = names(d.dea)[5:ncol(d.dea)],
                      direction = 'long') %>% 
  dplyr::mutate(date = lubridate::mdy(stringr::str_replace_all(time, 'X', '')),
                type = rep('death', (ncol(d.dea)-4)*nrow(d.dea))) %>% 
  dplyr::select(1, 2, 3, 4, 6, 7, 8, 9)
# - Cumulative final data in long format
covid.cum <- rbind(d.con.long, d.rec.long, d.dea.long)
#___________________________________________________________________Data 3 daily
# - Daily cases by type in wide format
d.con.daily <- cbind(d.con[, 1:5], # first day, today - yesterday
                     d.con[, 6:ncol(d.con)] - d.con[, 5:(ncol(d.con)-1)])
d.rec.daily <- cbind(d.rec[, 1:5], 
                     d.rec[, 6:ncol(d.rec)] - d.rec[, 5:(ncol(d.rec)-1)])
d.dea.daily <- cbind(d.dea[, 1:5], 
                     d.dea[, 6:ncol(d.dea)] - d.dea[, 5:(ncol(d.dea)-1)])
# - Confirmed cases in long format
d.con.daily.l <- reshape(data      = d.con.daily,
                         varying   = names(d.con.daily)[5:ncol(d.con.daily)],
                         v.names   = 'cases',
                         times     = names(d.con.daily)[5:ncol(d.con.daily)],
                         direction = 'long') %>% 
  dplyr::mutate(date = lubridate::mdy(stringr::str_replace_all(time, 'X', '')),
                type = rep('confirmed', 
                           (ncol(d.con.daily)-4)*nrow(d.con.daily))) %>%
  dplyr::select(1, 2, 3, 4, 6, 7, 8, 9)
# - Recovered
d.rec.daily.l <- reshape(data      = d.rec.daily,
                         varying   = names(d.rec.daily)[5:ncol(d.rec.daily)],
                         v.names   = 'cases',
                         times     = names(d.rec.daily)[5:ncol(d.rec.daily)],
                         direction = 'long') %>% 
  dplyr::mutate(date = lubridate::mdy(stringr::str_replace_all(time, 'X', '')),
                type = rep('recovered', 
                           (ncol(d.rec.daily)-4)*nrow(d.rec.daily))) %>%
  dplyr::select(1, 2, 3, 4, 6, 7, 8, 9)
# - Death
d.dea.daily.l <- reshape(data      = d.dea.daily,
                         varying   = names(d.dea.daily)[5:ncol(d.dea.daily)],
                         v.names   = 'cases',
                         times     = names(d.dea.daily)[5:ncol(d.dea.daily)],
                         direction = 'long') %>% 
  dplyr::mutate(date = lubridate::mdy(stringr::str_replace_all(time, 'X', '')),
                type = rep('death', 
                           (ncol(d.dea.daily)-4)*nrow(d.dea.daily))) %>% 
  dplyr::select(1, 2, 3, 4, 6, 7, 8, 9)
# - Daily final data long
coronavirus <- rbind(d.con.daily.l, d.rec.daily.l, d.dea.daily.l)
# - Check if data is updated
# max(coronavirus$date)
#___________________________________________________________Data 4 BR por Estado
d.munic <-
  read.csv(url("https://brasil.io/dataset/covid19/caso?format=csv")) %>%
  dplyr::mutate(date = as.Date(date))

d.estado <- d.munic %>%
  dplyr::filter(place_type == "state") %>%
  dplyr::arrange(date) %>% 
  dplyr::select(date, state, confirmed, deaths, estimated_population_2019)
#_________________________________________________________Data 5 population size
# Fonte: https://data.worldbank.org/indicator/SP.POP.TOTL
d.pop <- read.csv(url("https://raw.githubusercontent.com/grequena/coronavirusBR/master/popsize.csv"), sep = ';', header = TRUE)
# - Select only countries in coronavirus data
d.pop <- d.pop %>% 
  dplyr::filter(Country.Name %in% levels(coronavirus$Country.Region)) %>% 
  dplyr::arrange(Country.Name) %>% 
  dplyr::mutate(Country.Name = factor(Country.Name, levels = 
                                        c(levels(Country.Name), "Americas",
                                                 "Asia", "Africa", "Oceania",
                                                 "Europe")))
# - Check
# levels(coronavirus$Country.Region) == d.pop$Country.Name
# - Add total pop by continent and world
# Fonte: https://population.un.org/wpp/
d.pop[nrow(d.pop)+1, 1] <- "Americas"
d.pop[nrow(d.pop), 2] <- 579024000+422535000
d.pop[nrow(d.pop)+1, 1] <- "Asia"
d.pop[nrow(d.pop), 2] <- 4581757408
d.pop[nrow(d.pop)+1, 1] <- "Africa"
d.pop[nrow(d.pop), 2] <- 1216130000
d.pop[nrow(d.pop)+1, 1] <- "Europe"
d.pop[nrow(d.pop), 2] <- 738849000
d.pop[nrow(d.pop)+1, 1] <- "Oceania"
d.pop[nrow(d.pop), 2] <- 38304000
d.pop[nrow(d.pop)+1, 1] <- "World"
d.pop[nrow(d.pop), 2] <- 7576599408


#_______________________________________________________________________________
#_______________________________________________________________________________
#----------------------------------------------------------Data manipulation
#_________________________________________________________________________Brazil
# - Total number of cases in BR (sum for all dates)
dfBR <- coronavirus %>%
  dplyr::filter(Country.Region == "Brazil") %>%
  dplyr::group_by(Country.Region, type) %>%
  dplyr::summarise(total = sum(cases)) %>%
  tidyr::pivot_wider(names_from = type, values_from = total)
# - Daily cases in BR (cases per date)
df_dailyBR <- coronavirus %>%
  dplyr::filter(Country.Region == "Brazil") %>%
  dplyr::group_by(date, type) %>%
  dplyr::summarise(total = sum(cases, na.rm = TRUE)) %>%
  tidyr::pivot_wider(names_from = type,
                     values_from = total) %>%
  dplyr::arrange(date) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(confirmed_cum = cumsum(confirmed),
                death_cum = cumsum(death),
                recovered_cum = cumsum(recovered))
#__________________________________________________________________________World
# - Total cases by country (sum for all dates)
df <- coronavirus %>%
  dplyr::group_by(Country.Region, type) %>%
  dplyr::summarise(total = sum(cases)) %>%
  tidyr::pivot_wider(names_from = type, values_from = total) %>%
  dplyr::arrange(-confirmed)
# - Daily cases in world (sum for all countries)
df_daily <- coronavirus %>%
  dplyr::group_by(date, type) %>%
  dplyr::summarise(total = sum(cases, na.rm = TRUE)) %>%
  tidyr::pivot_wider(names_from = type,
                     values_from = total) %>%
  dplyr::arrange(date) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(confirmed_cum = cumsum(confirmed),
                death_cum = cumsum(death),
                recovered_cum = cumsum(recovered))
# - Daily cases by country
df_pais <- coronavirus %>%
  dplyr::group_by(Country.Region, date, type) %>%
  dplyr::summarise(total = sum(cases)) %>%
  tidyr::pivot_wider(names_from = type, values_from = total) %>%
  dplyr::arrange(date) %>%
  dplyr::ungroup() %>% 
  dplyr::group_by(Country.Region) %>%
  dplyr::mutate(confirmed_cum = cumsum(confirmed),
                death_cum = cumsum(death),
                recovered_cum = cumsum(recovered))
#_____________________________________________________________Daily by continent
# - Vector with all countries to extract `continent`
country <- as.character(levels(coronavirus$Country.Region))
country[country == "Kosovo"] <- "Russia" #so the function below results "Europe"
country[country == "Diamond Princess"] <- "Japan" #ship was in Yokohama port
#                                                  counts for "Asia", not Japan
country[country == "MS Zaandam"] <- "US" #more complicated but it's in "America" 
# - Continent from the vector country
continent <- countrycode::countrycode(sourcevar = country, 
                                      origin = "country.name",
                                      destination = "continent")
# - Data
df_cont <- df_pais
levels(df_cont$Country.Region) <- continent #now `Country.Region` is `continent`
df_cont <- df_cont %>% 
  dplyr::group_by(Country.Region, date) %>%
  dplyr::summarise(confirmed = sum(confirmed,na.rm = T), #by continent and date
                   recovered = sum(recovered,na.rm = T),
                   death = sum(death,na.rm = T)) %>% 
  dplyr::arrange(date)  %>% 
  dplyr::mutate(confirmed_cum = cumsum(confirmed), #still by continent and date
                death_cum = cumsum(death),
                recovered_cum = cumsum(recovered)) %>% 
  dplyr::ungroup()
df_cont$continent <- df_cont$Country.Region #create the variable continent
#_____________________________________________________________________Por estado
# brasil.io
# df_munic <- read.csv(url("https://brasil.io/dataset/covid19/caso?format=csv"))
# df_estado <- df_munic %>% 
#   dplyr::group_by(state, date) %>% 
#   dplyr::summarise(confirmed = sum(confirmed, na.rm = T),
#                 death = sum(deaths, na.rm = T)) %>% 
#   dplyr::arrange(date)
```





Resumo <!--- ---------------------------------------------------------------------------------------------------------------------------------------------- ---> {data-orientation=rows}
================================================================================





Row valueBox CONFIRMADOS {data-heigth=150}
--------------------------------------------------------------------------------

### {.value-box}

```{r}
flexdashboard::valueBox(
  value = format(dfBR$confirmed, big.mark = ".", decimal.mark = ","),
  caption = paste("Confirmados no <B>BRASIL</B> • ",
                  as.character.POSIXt(max(coronavirus$date), 
                                      format = "%d/%m/%Y")), 
  icon = "fas fa-diagnoses",
  color = confirmed_color
)
```

### {.value-box}

```{r}
flexdashboard::valueBox(
  value = paste(format(sum(df$confirmed), big.mark = ".", decimal.mark = ",")),
  caption = paste("Confirmados no <B>MUNDO</B> • ",
                  as.character.POSIXt(max(coronavirus$date),
                                      format = "%d/%m/%Y")),
  icon = "fas fa-diagnoses",
  color = confirmed_color
)
```





Row valueBox {data-heigth=150}
--------------------------------------------------------------------------------

### recovered {.value-box}

```{r}
flexdashboard::valueBox(
  value = paste(format(dfBR$recovered, big.mark = ".", decimal.mark = ","), 
                " (",
                format(round(100 * (dfBR$recovered / dfBR$confirmed), 1),
                       big.mark = ".", decimal.mark = ","), 
                "%)", sep = ""),
  caption = "Recuperados no <B>BRASIL</B>",
  icon = "fas fa-user-check",
  color = recovered_color
)
```

### recovered {.value-box}

```{r}
flexdashboard::valueBox(
  value = paste(format(sum(df$recovered, na.rm = TRUE),
                       big.mark = ".", decimal.mark = ","),
                " (", format(round(100 * sum(df$recovered, na.rm = TRUE) /
                                     sum(df$confirmed), 1),
                             big.mark = ".", decimal.mark = ","),
                "%)", sep = ""),
  caption = "Recuperados no <B>MUNDO</B>",
  icon = "fas fa-user-check",
  color = recovered_color
)
```





Row valueBox MORTES {data-heigth=150}
--------------------------------------------------------------------------------

### death {.value-box}

```{r}
flexdashboard::valueBox(
  value = paste(format(dfBR$death, big.mark = ".", decimal.mark = ","), 
                " (",
                format(round(100 * (dfBR$death / dfBR$confirmed), 1),
                       big.mark = ".", decimal.mark = ","), 
                "%)", sep = ""),
  caption = "Mortes no <B>BRASIL</B>",
  icon = "fas fa-user-times",
  color = death_color
)
```

### death {.value-box}

```{r}
flexdashboard::valueBox(
  value = paste(format(sum(df$death, na.rm = TRUE),
                       big.mark = ".", decimal.mark = ","),
                " (", format(round(100 * sum(df$death, na.rm = TRUE) /
                                     sum(df$confirmed), 1),
                             big.mark = ".", decimal.mark = ","),
                "%)", sep = ""),
  caption = "Mortes no <B>MUNDO</B>",
  icon = "fas fa-user-times",
  color = death_color
)
```





Row CHARTS CUMULATIVE FREQ {data-orientation=rows data-heigth=350}
--------------------------------------------------------------------------------

### **Evolução no BRASIL desde 25/02/2020**

```{r}
plotly::plot_ly(data = df_dailyBR %>% 
                  dplyr::filter(date > "2020-02-24")) %>%
  plotly::add_trace(x = ~date,
                    y = ~confirmed_cum,
                    type = "scatter",
                    mode = "lines+markers",
                    name = "Confirmados",
                    line = list(color = confirmed_color),
                    marker = list(color = confirmed_color)) %>%
  plotly::add_trace(x = ~date,
                    y = ~recovered_cum,
                    type = "scatter",
                    mode = "lines+markers",
                    name = "Recuperados",
                    opacity = 0.85,
                    line = list(color = recovered_color),
                    marker = list(color = recovered_color)) %>%
  plotly::add_trace(x = ~date,
                    y = ~death_cum,
                    type = "scatter",
                    mode = "lines+markers",
                    name = "Mortes",
                    opacity = 0.85,
                    line = list(color = death_color),
                    marker = list(color = death_color)) %>%
  plotly::add_annotations(x = as.Date("2020-02-26"),
                          y = 1,
                          text = paste("Primeiro caso"),
                          xref = "x",
                          yref = "y",
                          arrowhead = 5,
                          arrowhead = 5,
                          arrowsize = 1,
                          showarrow = TRUE,
                          ax = 0,
                          ay = -90) %>%
  plotly::add_annotations(x = as.Date("2020-03-17"),
                          y = 3,
                          text = paste("Primeira morte"),
                          xref = "x",
                          yref = "y",
                          arrowhead = 5,
                          arrowhead = 3,
                          arrowsize = 1,
                          showarrow = TRUE,
                          ax = 0,
                          ay = -90) %>%
  plotly::layout(title = "",
                 yaxis = list(title = "Frequência acumulada de casos"),
                 xaxis = list(title = ""),
                 legend = list(x = 0.1, y = 0.9),
                 hovermode = "compare")
```

### **Evolução no MUNDO desde 22/01/2020**

```{r}
plotly::plot_ly(data = df_daily) %>%
  plotly::add_trace(x = ~date,
                    y = ~confirmed_cum,
                    type = "scatter",
                    mode = "lines+markers",
                    name = "Confirmados",
                    marker = list(color = confirmed_color, 
                                  symbol = 'circle'),
                    line = list(color = confirmed_color)) %>%
  plotly::add_trace(x = ~date,
                    y = ~recovered_cum,
                    type = "scatter",
                    mode = "lines+markers",
                    name = "Recuperados",
                    opacity = 0.85,
                    line = list(color = recovered_color),
                    marker = list(color = recovered_color)) %>%
  plotly::add_trace(x = ~date,
                    y = ~death_cum,
                    type = "scatter",
                    mode = "lines+markers",
                    name = "Mortes",
                    opacity = 0.85,
                    line = list(color = death_color),
                    marker = list(color = death_color)) %>%
  plotly::layout(title = "",
                 yaxis = list(title = "Número de casos acumulado"),
                 xaxis = list(title = ""),
                 legend = list(x = 0.1, y = 0.9),
                 hovermode = "compare")
```





Row CHARTS ABS FREQ {data-heigth=350 data-orientation=rows}
--------------------------------------------------------------------------------

### **Casos diários no BRASIL desde 25/02/2020**

```{r}
plotly::plot_ly(data = df_dailyBR %>% 
                  dplyr::filter(date > "2020-02-24"), 
                x = ~ date, 
                y = ~ confirmed, 
                type = "bar", 
                name = "Confirmados",
                marker = list(color = confirmed_color)) %>%
  plotly::add_trace(y = ~ recovered, 
                    name = "Recuperados",
                    marker = list(color = recovered_color)) %>%
  plotly::add_trace(y = ~ death, 
                    name = "Mortes",
                    marker = list(color = death_color)) %>%
  plotly::layout(barmode = 'overlay',
                 yaxis = list(title = "Número de casos"),
                 xaxis = list(title = ""),
                 legend = list(x = 0.1, y = 0.9),
                 hovermode = "compare")
```

### **Casos diários no MUNDO desde 22/01/2020**

```{r}
plotly::plot_ly(data = df_daily, 
                x = ~ date, 
                y = ~ confirmed, 
                type = "bar", 
                name = "Confirmados",
                marker = list(color = confirmed_color)) %>%
  plotly::add_trace(y = ~ recovered, 
                    name = "Recuperados",
                    marker = list(color = recovered_color)) %>%
  plotly::add_trace(y = ~ death, 
                    name = "Mortes",
                    marker = list(color = death_color)) %>%
  plotly::layout(barmode = 'overlay',
                 yaxis = list(title = "Número de casos"),
                 xaxis = list(title = ""),
                 legend = list(x = 0.1, y = 0.9),
                 hovermode = "compare")
```





Continentes <!--- ----------------------------------------------------------------------------------------------------------------------------------------- ---> {data-orientation=rows data-navmenu="Mundo"}
================================================================================





<!-- Two tabs {.tabset} -->
<!-- ------------------ -->

Row {data-height=300}
--------------------------------------------------------------------------------

### Observações por **continente** até `r as.character.POSIXt(max(coronavirus$date), format = "%d/%m/%Y")`

```{r}
dfshow <- df_cont %>% 
  dplyr::group_by(continent) %>% 
  dplyr::summarise(Confirmados = sum(confirmed), 
                   Recuperados = sum(recovered),
                   Mortes = sum(death)) %>% 
  tidyr::pivot_longer(cols = c(continent), values_to = "Continente") %>% 
  dplyr::select(5, 1, 2, 3) %>% 
  dplyr::arrange(-Confirmados) %>% 
  dplyr::mutate(pop = d.pop[match(Continente, d.pop$Country.Name), 2]) %>% 
  dplyr::mutate(
    `Taxa de<br>Recuperação` = Recuperados/Confirmados,
    `Taxa de<br>Letalidade` = Mortes/Confirmados,
    `%C` = Confirmados/sum(Confirmados),
    `%R` = Recuperados/sum(Recuperados),
    `%M` = Mortes/sum(Mortes),
    con.pop = 1000000*(Confirmados / pop),
    rec.pop = 1000000*(Recuperados / pop),
    mor.pop = 1000000*(Mortes / pop)
  ) %>% 
  dplyr::select("Continente", 
                "Confirmados", "%C", 
                "Recuperados", "%R", "Taxa de<br>Recuperação",
                "Mortes", "%M", "Taxa de<br>Letalidade",
                "pop", "con.pop", "rec.pop", "mor.pop"
  )

names(dfshow)[1] <- ""
names(dfshow)[2] <- "Conf."
names(dfshow)[3] <- "% Conf."
names(dfshow)[4] <- "Recup."
names(dfshow)[5] <- "% Recup."
names(dfshow)[7] <- "Mortes"
names(dfshow)[8] <- "% Mortes"
names(dfshow)[10] <- "Total<br>Populacional"
names(dfshow)[11] <- "Conf.<br>em 100k"
names(dfshow)[12] <- "Recup.<br>em 100k"
names(dfshow)[13] <- "Mortes<br>em 100k"

sketch <- htmltools::withTags(
  table(
    DT::tableHeader(c(" ",colnames(dfshow)),# " " for rownames=T works properly
                    escape = F),# escape = F for html code
    DT::tableFooter(
      list("", "Total", # " " for rownames=T works properly
           format(sum(df$confirmed), big.mark = ".", decimal.mark = ","), 
           "100%", 
           format(sum(df$recovered), big.mark = ".", decimal.mark = ","), 
           "100%",
           paste0(
             format(
               round(100*sum(df$recovered)/sum(df$confirmed), 1), 
               decimal.mark = ",", big.mark = "."),
             "%"),
           format(sum(df$death), big.mark = ".", decimal.mark = ","), 
           "100%",
           paste0(
             format(
               round(100*sum(df$death)/sum(df$confirmed), 1), 
               decimal.mark = ",", big.mark = ","),
             "%"),
           format(
             d.pop$pop2018[d.pop$Country.Name=="World"], 
            big.mark = ".", decimal.mark = ","
           ),
           format(
             round(
               1000000*(sum(df$confirmed)/
                         d.pop$pop2018[d.pop$Country.Name=="World"]),
               1),
             decimal.mark = ",", big.mark = "."
           ),
           format(
             round(
               1000000*(sum(df$recovered)/
                         d.pop$pop2018[d.pop$Country.Name=="World"]),
               1),
             decimal.mark = ",", big.mark = "."
           ),
           format(
             round(
               1000000*(sum(df$death)/
                         d.pop$pop2018[d.pop$Country.Name=="World"]),
               1),
            decimal.mark = ",", big.mark = "."
           )
      )
    )
  )
)

DT::datatable(dfshow, 
              options = list(
                dom = "t",
                columnDefs = list(list(className = 'dt-center', 
                                       targets = "_all")),
                lengthChange = FALSE
              ),
              escape = F,
              container = sketch
)%>%
  DT::formatPercentage(c(3, 5, 6, 8, 9), 
                       digits = 1
  ) %>% 
  DT::formatRound(c(11, 12, 13), digits = 1)
  
```

> Legenda: 
Conf. = Confirmados,
% Conf. $= \frac{Confirmados}{Total(Confirmados)}$, 
Recup. = Recuperados,
% Recup. $= \frac{Recuperados}{Total(Recuperados)}$, 
Taxa de recuperação $= \frac{Recuperados}{Confirmados}$,
% Mortes $= \frac{Mortes}{Total(Mortes)}$,
Taxa de Letalidade $= \frac{Mortes}{Confirmados}$,
Conf. em 100k = $100.000\frac{Confirmados}{Total Populacional}$,
Recup. em 100k = $100.000\frac{Recuperados}{Total Populacional}$ e
Mortes em 100k = $100.000\frac{Mortes}{Total Populacional}$. <br>
Obs.: "Conf. em 100k" é o número de casos confirmados em 100.000 habitantes, dos quais "Recup. em 100k" se recuperaram e "Mortes em 100k" foram a óbito. Por exemplo, na Europa, `r round(dfshow[,11][dfshow[,1]=="Europe"], 1)` a cada 100.000 foram confirmados, dos quais `r round(dfshow[,12][dfshow[,1]=="Europe"], 1)` se recuperaram e `r round(dfshow[,13][dfshow[,1]=="Europe"], 1)` morreram.





Row {data-height=300}
--------------------------------------------------------------------------------

### Em valores absolutos

```{r}
dfshow1 <- df_cont %>% 
  dplyr::group_by(continent) %>% 
  dplyr::summarise(confirmed = sum(confirmed), 
                   recovered = sum(recovered),
                   death = sum(death)) %>% 
  tidyr::pivot_longer(cols = c(continent), values_to = "continent") %>% 
  dplyr::select(5, 1, 2, 3) %>% 
  dplyr::arrange(-confirmed)
dfshow1$continent <- factor(dfshow1$continent, levels = dfshow1$continent)

plotly::plot_ly(data = dfshow1, 
                x = ~ continent, 
                y = ~ confirmed, 
                type = "bar", 
                name = "Confirmados",
                marker = list(color = confirmed_colorT)) %>%
  plotly::add_trace(y = ~ recovered, 
                    name = "Recuperados",
                    marker = list(color = recovered_colorT)) %>%
  plotly::add_trace(y = ~ death, 
                    name = "Mortes",
                    marker = list(color = death_colorT)) %>%
  plotly::layout(barmode = 'group',
                 yaxis = list(title = "Número de casos"),
                 xaxis = list(title = ""),
                 legend = list(x = 0.8, y = 0.9),
                 hovermode = "compare")
```





Row {data-height=350}
--------------------------------------------------------------------------------

### **<span style="color: #1478BE;">CONFIRMADOS</span>** em valores absolutos

```{r}
df_cont$continent <- factor(df_cont$continent, levels = c("Oceania", "Africa",
                                                          "Americas", "Europe",
                                                          "Asia"))
total <- df_cont %>% 
  dplyr::group_by(continent) %>% 
  dplyr::summarise(con=sum(confirmed),
                   rec=sum(recovered),
                   dea=sum(death))
maxdate <- max(df_cont$date)
fig <- df_cont %>% 
  ggplot2::ggplot(ggplot2::aes(x = date, y = confirmed_cum, fill = continent)) +
  ggplot2::geom_area(alpha=0.7 , size=.7, colour="black") +
  viridis::scale_fill_viridis(discrete = T, name = " ", option = "D") +
  ggplot2::ylab("Frequência acumulada")+
  ggplot2::xlab("")+
  ggplot2::scale_y_continuous(labels = function(x) format(x, scientific = F))+
  ggplot2::theme_bw(base_size=20)+
  ggplot2::theme(panel.border     = ggplot2::element_blank(),
                 panel.background = ggplot2::element_blank(),
                 legend.position  = c(0.2, 0.65),
                 axis.text        = ggplot2::element_text(size=12),
                 axis.title       = ggplot2::element_text(size=15))
fig


```

### **<span style="color:#0A780AE6">RECUPERADOS</span>** em valores absolutos

```{r}
fig <- df_cont %>% 
  ggplot2::ggplot(ggplot2::aes(x = date, y = recovered_cum, fill = continent,
                               tooltip = recovered_cum)) +
  ggplot2::geom_area(alpha=0.7 , size=.7, colour="black") +
  viridis::scale_fill_viridis(discrete = T, name = " ", option = "D") +
  ggplot2::ylab("")+
  ggplot2::xlab("")+
  ggplot2::scale_y_continuous(labels = function(x) format(x, scientific = F))+
  ggplot2::theme_bw(base_size=20)+
  ggplot2::theme(panel.border     = ggplot2::element_blank(),
                 panel.background = ggplot2::element_blank(),
                 legend.position  = c(0.2, 0.65),
                 axis.text        = ggplot2::element_text(size=12),
                 axis.title       = ggplot2::element_text(size=15))
fig
```

### **<span style="color:#DC2828E6">MORTES</span>** em valores absolutos

```{r}
fig <- df_cont %>% 
  ggplot2::ggplot(ggplot2::aes(x = date, y = death_cum, fill = continent)) +
  ggplot2::geom_area(alpha=0.7 , size=.7, colour="black") +
  viridis::scale_fill_viridis(discrete = T, name = " ", option = "D") +
  ggplot2::ylab("")+
  ggplot2::xlab("")+
  ggplot2::scale_y_continuous(labels = function(x) format(x, scientific = F))+
  ggplot2::theme_bw(base_size=20)+
  ggplot2::theme(panel.border     = ggplot2::element_blank(),
                 panel.background = ggplot2::element_blank(),
                 legend.position  = c(0.2, 0.65),
                 axis.text        = ggplot2::element_text(size=12),
                 axis.title       = ggplot2::element_text(size=15))
fig
```





Row {data-height=300}
--------------------------------------------------------------------------------

### **Considerando o tamanho da população**

```{r}
names(dfshow)[1] <- "continent"

dfshow <- dfshow %>% 
  dplyr::arrange(-`Conf.<br>em 100k`)
dfshow$continent <- factor(dfshow$continent, levels = dfshow$continent)


plotly::plot_ly(data = dfshow, 
                x = ~ continent, 
                y = ~ `Conf.<br>em 100k`, 
                type = "bar", 
                name = "Confirmados",
                marker = list(color = confirmed_colorT)) %>%
  plotly::add_trace(y = ~ `Recup.<br>em 100k`, 
                    name = "Recuperados",
                    marker = list(color = recovered_colorT)) %>%
  plotly::add_trace(y = ~ `Mortes<br>em 100k`, 
                    name = "Mortes",
                    marker = list(color = death_colorT)) %>%
  plotly::layout(barmode = 'group',
                 yaxis = list(title = "Nº de casos em 100.000 habitantes"),
                 xaxis = list(title = ""),
                 legend = list(x = 0.8, y = 0.9),
                 hovermode = "compare")
```





Países mais afetados <!--- ----------------------------------------------------------------------------------------------------------------------------------------------------------- ---> {data-orientation=rows data-navmenu="Mundo"}
================================================================================





Row {data-height=550}
--------------------------------------------------------------------------------

### Observações por **país** até `r as.character.POSIXt(max(coronavirus$date), format = "%d/%m/%Y")`

```{r}
dfshow <- df %>% 
  dplyr::group_by(Country.Region) %>% 
  dplyr::mutate(pop = d.pop[match(Country.Region, d.pop$Country.Name), 2],
                Confirmados = confirmed,
                Recuperados = recovered,
                Mortes = death) %>% 
  dplyr::mutate(
    `Taxa de<br>Recuperação` = Recuperados/Confirmados,
    `Taxa de<br>Letalidade` = Mortes/Confirmados,
    `%C` = Confirmados/sum(df$confirmed),
    `%R` = Recuperados/sum(df$recovered),
    `%M` = Mortes/sum(df$death),
    con.pop = 100000*(Confirmados / pop),
    rec.pop = 100000*(Recuperados / pop),
    mor.pop = 100000*(Mortes / pop)
  ) %>% 
  dplyr::select("Country.Region", 
                "Confirmados", "%C", 
                "Recuperados", "%R", "Taxa de<br>Recuperação",
                "Mortes", "%M", "Taxa de<br>Letalidade",
                "pop", "con.pop", "rec.pop", "mor.pop"
  )

names(dfshow)[1] <- " "
names(dfshow)[2] <- "Conf."
names(dfshow)[3] <- "% Conf."
names(dfshow)[4] <- "Recup."
names(dfshow)[5] <- "% Recup."
names(dfshow)[7] <- "Mortes"
names(dfshow)[8] <- "% Mortes"
names(dfshow)[10] <- "Total<br>Populacional"
names(dfshow)[11] <- "Conf.<br>em 100k"
names(dfshow)[12] <- "Recup.<br>em 100k"
names(dfshow)[13] <- "Mortes<br>em 100k"
# dfshow$Country.Region <- factor(dfshow$Country.Region, 
#                                 levels = dfshow$Country.Region)

DT::datatable(dfshow, 
              options = list(
                columnDefs = list(list(className = 'dt-center', 
                                       targets = "_all")),
                lengthChange = FALSE,
                order = list(list(2, 'desc'))
              ),
              escape = F
)%>%
  DT::formatPercentage(c(3, 5, 6, 8, 9), 
                       digits = 1
  ) %>% 
  DT::formatRound(c(11, 12, 13), digits = 1)
```

> Legenda: 
Conf. = Confirmados,
% Conf. $= \frac{Confirmados}{Total(Confirmados)}$, 
Recup. = Recuperados,
% Recup. $= \frac{Recuperados}{Total(Recuperados)}$, 
Taxa de recuperação $= \frac{Recuperados}{Confirmados}$,
% Mortes $= \frac{Mortes}{Total(Mortes)}$,
Taxa de Letalidade $= \frac{Mortes}{Confirmados}$,
Conf. em 100k = $100.000\frac{Confirmados}{Total Populacional}$,
Recup. em 100k = $100.000\frac{Recuperados}{Total Populacional}$ e
Mortes em 100k = $100.000\frac{Mortes}{Total Populacional}$. <br>
Obs.: "Conf. em 100k" é o número de casos confirmados em 100.000 habitantes, dos quais "Recup. em 100k" se recuperaram e "Mortes em 100k" foram a óbito. Por exemplo, nos EUA, `r round(dfshow[,11][dfshow[,1]=="US"], 1)` a cada 100.000 foram confirmados, dos quais `r round(dfshow[,12][dfshow[,1]=="US"], 1)` se recuperaram e `r round(dfshow[,13][dfshow[,1]=="US"], 1)` morreram.





Row {data-height=300}
--------------------------------------------------------------------------------

### Em valores absolutos

```{r}
m <- 20
dfshow1 <- df
dfshow1$Country.Region <- factor(dfshow1$Country.Region, 
                                levels = dfshow1$Country.Region)

plotly::plot_ly(data = dfshow1[1:m, ], 
                x = ~ Country.Region, 
                y = ~ confirmed, 
                type = "bar", 
                name = "Confirmados",
                marker = list(color = confirmed_colorT)) %>%
  plotly::add_trace(y = ~ recovered, 
                    name = "Recuperados",
                    marker = list(color = recovered_colorT)) %>%
  plotly::add_trace(y = ~ death, 
                    name = "Mortes",
                    marker = list(color = death_colorT)) %>%
  plotly::layout(barmode = 'group',
                 yaxis = list(title = "Número de casos"),
                 xaxis = list(title = ""),
                 legend = list(x = 0.8, y = 0.9),
                 hovermode = "compare")
```





Row {data-height=350}
--------------------------------------------------------------------------------

### **<span style="color: #1478BE;">CONFIRMADOS</span>** em valores absolutos

```{r}
m <- 7
country <- c(as.character(df$Country.Region[1:m]))

country_ordem <- df_pais %>% 
  dplyr::group_by(Country.Region) %>% 
  dplyr::summarise(ordem = sum(confirmed_cum)) %>% 
  dplyr::arrange(-ordem) %>% 
  dplyr::select(Country.Region)
country_ordem <- data.frame(country_ordem)[, 1]

df_mpaises <- df_pais %>% 
  dplyr::filter(Country.Region %in% country) %>%
  dplyr::arrange(date)

df_mpaises$Country.Region <- factor(df_mpaises$Country.Region, 
                                    levels = c("US", "France", "Germany",
                                    "Spain", "Italy",
                                    "Iran", "China"))
                                      
fig <- df_mpaises %>% 
  ggplot2::ggplot(ggplot2::aes(x = date, 
                               y = confirmed_cum, 
                               fill = Country.Region)) +
  ggplot2::geom_area(alpha=0.7 , size=.7, colour="black") +
  viridis::scale_fill_viridis(discrete = T, name = " ", option = "A") +
  ggplot2::ylab("Frequência acumulada")+
  ggplot2::xlab("")+
  ggplot2::scale_y_continuous(labels = function(x) format(x, scientific = F))+
  ggplot2::theme_bw(base_size=20)+
  ggplot2::theme(panel.border     = ggplot2::element_blank(),
                 panel.background = ggplot2::element_blank(),
                 legend.position  = c(0.2, 0.65),
                 axis.text        = ggplot2::element_text(size=12),
                 axis.title       = ggplot2::element_text(size=15))
 
fig
```

### **<span style="color:#0A780AE6">RECUPERADOS</span>** em valores absolutos

```{r}
fig <- df_mpaises %>% 
  ggplot2::ggplot(ggplot2::aes(x = date, 
                               y = recovered_cum, 
                               fill = Country.Region)) +
  ggplot2::geom_area(alpha=0.7 , size=.7, colour="black") +
  viridis::scale_fill_viridis(discrete = T, name = " ", option = "A") +
  ggplot2::ylab("")+
  ggplot2::xlab("")+
  ggplot2::scale_y_continuous(labels = function(x) format(x, scientific = F))+
  ggplot2::theme_bw(base_size=20)+
  ggplot2::theme(panel.border     = ggplot2::element_blank(),
                 panel.background = ggplot2::element_blank(),
                 legend.position  = c(0.2, 0.65),
                 axis.text        = ggplot2::element_text(size=12),
                 axis.title       = ggplot2::element_text(size=15))
 
fig
```

### **<span style="color:#DC2828E6">MORTES</span>** em valores absolutos

```{r}
fig <- df_mpaises %>% 
  ggplot2::ggplot(ggplot2::aes(x = date, 
                               y = death_cum, 
                               fill = Country.Region)) +
  ggplot2::geom_area(alpha=0.7 , size=.7, colour="black") +
  viridis::scale_fill_viridis(discrete = T, name = " ", option = "A") +
  ggplot2::ylab("")+
  ggplot2::xlab("")+
  ggplot2::scale_y_continuous(labels = function(x) format(x, scientific = F))+
  ggplot2::theme_bw(base_size=20)+
  ggplot2::theme(panel.border     = ggplot2::element_blank(),
                 panel.background = ggplot2::element_blank(),
                 legend.position  = c(0.2, 0.65),
                 axis.text        = ggplot2::element_text(size=12),
                 axis.title       = ggplot2::element_text(size=15))
 
fig
```





Row {data-height=300}
--------------------------------------------------------------------------------

### **Considerando o tamanho da população**

```{r}
m <- 20
dfshow <- df %>% 
  dplyr::filter(Country.Region != "Holy See" &
                  Country.Region != "San Marino" & 
                  Country.Region != "Andorra") %>% 
  dplyr::group_by(Country.Region) %>% 
  dplyr::mutate(pop = d.pop[match(Country.Region, d.pop$Country.Name), 2],
                Confirmados = confirmed,
                Recuperados = recovered,
                Mortes = death) %>% 
  dplyr::mutate(
    `Taxa de<br>Recuperação` = Recuperados/Confirmados,
    `Taxa de<br>Letalidade` = Mortes/Confirmados,
    `%C` = Confirmados/sum(df$confirmed),
    `%R` = Recuperados/sum(df$recovered),
    `%M` = Mortes/sum(df$death),
    con.pop = 100000*(Confirmados / pop),
    rec.pop = 100000*(Recuperados / pop),
    mor.pop = 100000*(Mortes / pop)
  ) %>% 
  dplyr::select("Country.Region", 
                "Confirmados", "%C", 
                "Recuperados", "%R", "Taxa de<br>Recuperação",
                "Mortes", "%M", "Taxa de<br>Letalidade",
                "pop", "con.pop", "rec.pop", "mor.pop"
  ) %>% 
  dplyr::arrange(-con.pop)
dfshow$Country.Region <- factor(dfshow$Country.Region, 
                                levels = dfshow$Country.Region)


plotly::plot_ly(data = dfshow[1:m, ], 
                x = ~ Country.Region, 
                y = ~ con.pop, 
                type = "bar", 
                name = "Confirmados",
                marker = list(color = confirmed_colorT)) %>%
  plotly::add_trace(y = ~ rec.pop, 
                    name = "Recuperados",
                    marker = list(color = recovered_colorT)) %>%
  plotly::add_trace(y = ~ mor.pop, 
                    name = "Mortes",
                    marker = list(color = death_colorT)) %>%
  plotly::layout(barmode = 'group',
                 yaxis = list(title = "Nº de casos em 100.000 habitantes"),
                 xaxis = list(title = ""),
                 legend = list(x = 0.8, y = 0.9),
                 hovermode = "compare")
```

> Nota: somente foram considerados neste gráfico os países/regiões com mais de 100.000 habitantes. Até `r as.character.POSIXt(max(coronavirus$date), "%d/%m/%Y")`, a Cidade do Vaticano (Holy See), San Marino e Andorra têm as maiores quantidades de confirmados por habitante, mas têm menos do que 100.000 habitantes (consulte na caixa de busca na tabela acima).





América do Sul <!--- -------------------------------------------------------------------------------------------------------------------------------------- ---> {data-orientation=rows data-navmenu="Mundo"}
================================================================================





Row {data-height=600}
--------------------------------------------------------------------------------

### Observações por **país na América do Sul** até `r as.character.POSIXt(max(coronavirus$date), format = "%d/%m/%Y")`

```{r}
country_sa <- df$Country.Region[df$Country.Region%in%c("Argentina", "Bolivia",
                                                       "Brazil", "Chile",
                                                       "Colombia", "Ecuador",
                                                       "Guyana", "Paraguay",
                                                       "Peru", "Suriname",
                                                       "Uruguay", "Venezuela")]

totalSA <- df_pais %>% 
  dplyr::filter(Country.Region %in% country_sa) %>%
  dplyr::summarise(Confirmados = sum(confirmed),
                   Recuperados = sum(recovered),
                   Mortes = sum(death)) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(2, 3, 4) %>% 
  dplyr::summarise(con = sum(Confirmados),
                   rec = sum(Recuperados),
                   dea = sum(Mortes))

dfshow <- df_pais %>% 
  dplyr::filter(Country.Region %in% country_sa) %>%
  dplyr::summarise(Confirmados = sum(confirmed),
                   Recuperados = sum(recovered),
                   Mortes = sum(death)) %>% 
  dplyr::arrange(-Confirmados) %>% 
  dplyr::group_by(Country.Region) %>% 
  dplyr::mutate(pop = d.pop[match(Country.Region, d.pop$Country.Name), 2]) %>% 
  dplyr::mutate(
    `Taxa de<br>Recuperação` = Recuperados/Confirmados,
    `Taxa de<br>Letalidade` = Mortes/Confirmados,
    `%C` = Confirmados/totalSA$con,
    `%R` = Recuperados/totalSA$rec,
    `%M` = Mortes/totalSA$dea,
    con.pop = 100000*(Confirmados / pop),
    rec.pop = 100000*(Recuperados / pop),
    mor.pop = 100000*(Mortes / pop)
  ) %>% 
  dplyr::select("Country.Region", 
                "Confirmados", "%C", 
                "Recuperados", "%R", "Taxa de<br>Recuperação",
                "Mortes", "%M", "Taxa de<br>Letalidade",
                "pop", "con.pop", "rec.pop", "mor.pop"
  )
dfshow$Country.Region <- factor(dfshow$Country.Region, 
                                levels = as.character(country_sa))

names(dfshow)[1] <- " "
names(dfshow)[2] <- "Conf."
names(dfshow)[3] <- "% Conf."
names(dfshow)[4] <- "Recup."
names(dfshow)[5] <- "% Recup."
names(dfshow)[7] <- "Mortes"
names(dfshow)[8] <- "% Mortes"
names(dfshow)[10] <- "Total<br>Populacional"
names(dfshow)[11] <- "Conf.<br>em 100k"
names(dfshow)[12] <- "Recup.<br>em 100k"
names(dfshow)[13] <- "Mortes<br>em 100k"

sketch <- htmltools::withTags(
  table(
    DT::tableHeader(c(" ",colnames(dfshow)),# " " for rownames=T works properly
                    escape = F),# escape = F for html code
    DT::tableFooter(
      list("", "Total", # " " for rownames=T works properly
           format(totalSA$con, big.mark = ".", decimal.mark = ","), 
           "100%", 
           format(totalSA$rec, big.mark = ".", decimal.mark = ","), 
           "100%",
           paste0(
             format(
               round(100*totalSA$rec/totalSA$con, 1), 
               decimal.mark = ",", big.mark = "."),
             "%"),
           format(totalSA$dea, big.mark = ".", decimal.mark = ","), 
           "100%",
           paste0(
             format(
               round(100*totalSA$dea/totalSA$con, 1), 
               decimal.mark = ",", big.mark = "."),
             "%"),
           format(
             sum(d.pop$pop2018[d.pop$Country.Name %in% country_sa]), 
            big.mark = ".", decimal.mark = ","
           ),
           format(
             round(
               100000*(totalSA$con/
                         sum(d.pop$pop2018[d.pop$Country.Name%in%country_sa])),
               1),
             decimal.mark = ",", big.mark = "."
           ),
           format(
             round(
               100000*(totalSA$rec/
                         sum(d.pop$pop2018[d.pop$Country.Name%in%country_sa])),
               1),
             decimal.mark = ",", big.mark = "."
           ),
           format(
             round(
               100000*(totalSA$dea/
                         sum(d.pop$pop2018[d.pop$Country.Name%in%country_sa])),
               1),
            decimal.mark = ",", big.mark = "."
           )
      )
    )
  )
)

DT::datatable(dfshow, 
              options = list(
                dom = "t",
                columnDefs = list(list(className = 'dt-center', 
                                       targets = "_all")),
                lengthChange = FALSE,
                pageLength = length(country_sa)
              ),
              escape = F,
              container = sketch
)%>%
  DT::formatPercentage(c(3, 5, 6, 8, 9), 
                       digits = 1
  ) %>% 
  DT::formatRound(c(11, 12, 13), digits = 1)
```

> Legenda: 
Conf. = Confirmados,
% Conf. $= \frac{Confirmados}{Total(Confirmados)}$, 
Recup. = Recuperados,
% Recup. $= \frac{Recuperados}{Total(Recuperados)}$, 
Taxa de recuperação $= \frac{Recuperados}{Confirmados}$,
% Mortes $= \frac{Mortes}{Total(Mortes)}$,
Taxa de Letalidade $= \frac{Mortes}{Confirmados}$,
Conf. em 100k = $100.000\frac{Confirmados}{Total Populacional}$,
Recup. em 100k = $100.000\frac{Recuperados}{Total Populacional}$ e
Mortes em 100k = $100.000\frac{Mortes}{Total Populacional}$. <br>
Obs.: "Conf. em 100k" é o número de casos confirmados em 100.000 habitantes, dos quais "Recup. em 100k" se recuperaram e "Mortes em 100k" foram a óbito. Por exemplo, no Brasil, `r round(dfshow[,11][dfshow[,1]=="Brazil"], 1)` a cada 100.000 foram confirmados, dos quais `r round(dfshow[,12][dfshow[,1]=="Brazil"], 1)` se recuperaram e `r round(dfshow[,13][dfshow[,1]=="Brazil"], 1)` morreram.





Row {data-height=300}
-------------------------

### Em valores absolutos

```{r}
country_sa <- df$Country.Region[df$Country.Region%in%c("Argentina", "Bolivia",
                                                       "Brazil", "Chile",
                                                       "Colombia", "Ecuador",
                                                       "Guyana", "Paraguay",
                                                       "Peru", "Suriname",
                                                       "Uruguay", "Venezuela")]

totalSA <- df_pais %>% 
  dplyr::filter(Country.Region %in% country_sa) %>%
  dplyr::summarise(Confirmados = sum(confirmed),
                   Recuperados = sum(recovered),
                   Mortes = sum(death)) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(2, 3, 4) %>% 
  dplyr::summarise(con = sum(Confirmados),
                   rec = sum(Recuperados),
                   dea = sum(Mortes))

dfshow <- df_pais %>% 
  dplyr::filter(Country.Region %in% country_sa) %>%
  dplyr::summarise(Confirmados = sum(confirmed),
                   Recuperados = sum(recovered),
                   Mortes = sum(death)) %>% 
  dplyr::arrange(-Confirmados) %>% 
  dplyr::group_by(Country.Region) %>% 
  dplyr::mutate(pop = d.pop[match(Country.Region, d.pop$Country.Name), 2]) %>% 
  dplyr::mutate(
    `Taxa de<br>Recuperação` = Recuperados/Confirmados,
    `Taxa de<br>Letalidade` = Mortes/Confirmados,
    `%C` = Confirmados/totalSA$con,
    `%R` = Recuperados/totalSA$rec,
    `%M` = Mortes/totalSA$dea,
    con.pop = 100000*(Confirmados / pop),
    rec.pop = 100000*(Recuperados / pop),
    mor.pop = 100000*(Mortes / pop)
  ) %>% 
  dplyr::select("Country.Region", 
                "Confirmados", "%C", 
                "Recuperados", "%R", "Taxa de<br>Recuperação",
                "Mortes", "%M", "Taxa de<br>Letalidade",
                "pop", "con.pop", "rec.pop", "mor.pop"
  )
dfshow$Country.Region <- factor(dfshow$Country.Region, 
                                levels = as.character(country_sa))
names(dfshow)[1] <- "País/Região"
plotly::plot_ly(data = dfshow, 
                x = ~ `País/Região`, 
                y = ~ Confirmados, 
                type = "bar", 
                name = "Confirmados",
                marker = list(color = confirmed_colorT)) %>%
  plotly::add_trace(y = ~ Recuperados, 
                    name = "Recuperados",
                    marker = list(color = recovered_colorT)) %>%
  plotly::add_trace(y = ~ Mortes, 
                    name = "Mortes",
                    marker = list(color = death_colorT)) %>%
  plotly::layout(barmode = 'group',
                 yaxis = list(title = "Número de casos"),
                 xaxis = list(title = ""),
                 legend = list(x = 0.8, y = 0.9),
                 hovermode = "compare")
```





Row {data-height=350}
-------------------------

### **<span style="color: #1478BE;">CONFIRMADOS</span>** em valores absolutos

```{r}
m <- 4

country_sa <- df$Country.Region[df$Country.Region%in%c("Argentina", "Bolivia",
                                                       "Brazil", "Chile",
                                                       "Colombia", "Ecuador",
                                                       "Guyana", "Paraguay",
                                                       "Peru", "Suriname",
                                                       "Uruguay", "Venezuela")]

df_samerica <- df_pais %>% 
  dplyr::filter(Country.Region %in% country_sa[1:m]) %>%
  dplyr::filter(date >= "2020-03-02") %>% 
  dplyr::arrange(date)

df_samerica$Country.Region <- factor(df_samerica$Country.Region, 
                                    levels = rev(country_sa[1:m]))


fig <- df_samerica %>% 
  ggplot2::ggplot(ggplot2::aes(x = date, 
                               y = confirmed_cum, 
                               fill = Country.Region)) +
  ggplot2::geom_area(alpha=0.7 , size=.7, colour="black") +
  viridis::scale_fill_viridis(discrete = T, name = " ", option = "E") +
  ggplot2::ylab("Frequência acumulada")+
  ggplot2::xlab("")+
  ggplot2::scale_y_continuous(labels = function(x) format(x, scientific = F))+
  ggplot2::theme_bw(base_size=20)+
  ggplot2::theme(panel.border     = ggplot2::element_blank(),
                 panel.background = ggplot2::element_blank(),
                 legend.position  = c(0.2, 0.65),
                 axis.text        = ggplot2::element_text(size=12),
                 axis.title       = ggplot2::element_text(size=15))
 
fig
```

### **<span style="color:#0A780AE6">RECUPERADOS</span>** em valores absolutos

```{r}
fig <- df_samerica %>% 
  ggplot2::ggplot(ggplot2::aes(x = date, 
                               y = recovered_cum, 
                               fill = Country.Region)) +
  ggplot2::geom_area(alpha=0.7 , size=.7, colour="black") +
  viridis::scale_fill_viridis(discrete = T, name = " ", option = "E") +
  ggplot2::ylab("")+
  ggplot2::xlab("")+
  ggplot2::scale_y_continuous(labels = function(x) format(x, scientific = F))+
  ggplot2::theme_bw(base_size=20)+
  ggplot2::theme(panel.border     = ggplot2::element_blank(),
                 panel.background = ggplot2::element_blank(),
                 legend.position  = c(0.2, 0.65),
                 axis.text        = ggplot2::element_text(size=12),
                 axis.title       = ggplot2::element_text(size=15))
 
fig
```

### **<span style="color:#DC2828E6">MORTES</span>** em valores absolutos

```{r}
fig <- df_samerica %>% 
  ggplot2::ggplot(ggplot2::aes(x = date, 
                               y = death_cum, 
                               fill = Country.Region)) +
  ggplot2::geom_area(alpha=0.7 , size=.7, colour="black") +
  viridis::scale_fill_viridis(discrete = T, name = " ", option = "E") +
  ggplot2::ylab("")+
  ggplot2::xlab("")+
  ggplot2::scale_y_continuous(labels = function(x) format(x, scientific = F))+
  ggplot2::theme_bw(base_size=20)+
  ggplot2::theme(panel.border     = ggplot2::element_blank(),
                 panel.background = ggplot2::element_blank(),
                 legend.position  = c(0.2, 0.65),
                 axis.text        = ggplot2::element_text(size=12),
                 axis.title       = ggplot2::element_text(size=15))
 
fig
```





Row {data-height=300}
--------------------------------------------------------------------------------

### **Considerando o tamanho da população**

```{r}
country_sa <- df$Country.Region[df$Country.Region%in%c("Argentina", "Bolivia",
                                                       "Brazil", "Chile",
                                                       "Colombia", "Ecuador",
                                                       "Guyana", "Paraguay",
                                                       "Peru", "Suriname",
                                                       "Uruguay", "Venezuela")]

totalSA <- df_pais %>% 
  dplyr::filter(Country.Region %in% country_sa) %>%
  dplyr::summarise(Confirmados = sum(confirmed),
                   Recuperados = sum(recovered),
                   Mortes = sum(death)) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(2, 3, 4) %>% 
  dplyr::summarise(con = sum(Confirmados),
                   rec = sum(Recuperados),
                   dea = sum(Mortes))

dfshow <- df_pais %>% 
  dplyr::filter(Country.Region %in% country_sa) %>%
  dplyr::summarise(Confirmados = sum(confirmed),
                   Recuperados = sum(recovered),
                   Mortes = sum(death)) %>% 
  dplyr::arrange(-Confirmados) %>% 
  dplyr::group_by(Country.Region) %>% 
  dplyr::mutate(pop = d.pop[match(Country.Region, d.pop$Country.Name), 2]) %>% 
  dplyr::mutate(
    `Taxa de<br>Recuperação` = Recuperados/Confirmados,
    `Taxa de<br>Letalidade` = Mortes/Confirmados,
    `%C` = Confirmados/totalSA$con,
    `%R` = Recuperados/totalSA$rec,
    `%M` = Mortes/totalSA$dea,
    con.pop = 100000*(Confirmados / pop),
    rec.pop = 100000*(Recuperados / pop),
    mor.pop = 100000*(Mortes / pop)
  ) %>% 
  dplyr::select("Country.Region", 
                "Confirmados", "%C", 
                "Recuperados", "%R", "Taxa de<br>Recuperação",
                "Mortes", "%M", "Taxa de<br>Letalidade",
                "pop", "con.pop", "rec.pop", "mor.pop"
  ) %>% 
  dplyr::arrange(-con.pop)

dfshow$Country.Region <- factor(dfshow$Country.Region, 
                                levels = dfshow$Country.Region)

names(dfshow)[1] <- "País/Região"
plotly::plot_ly(data = dfshow, 
                x = ~ `País/Região`, 
                y = ~ con.pop, 
                type = "bar", 
                name = "Confirmados",
                marker = list(color = confirmed_colorT)) %>%
  plotly::add_trace(y = ~ rec.pop, 
                    name = "Recuperados",
                    marker = list(color = recovered_colorT)) %>%
  plotly::add_trace(y = ~ mor.pop, 
                    name = "Mortes",
                    marker = list(color = death_colorT)) %>%
  plotly::layout(barmode = 'group',
                 yaxis = list(title = "Nº de casos em 100.000 habitantes"),
                 xaxis = list(title = ""),
                 legend = list(x = 0.8, y = 0.9),
                 hovermode = "compare")
```





Estados {data-orientation=rows data-navmenu="Brasil"}
================================================================================





Row {data-height=550}
--------------------------------------------------------------------------------

### Observações no **Brasil por estado** até `r as.character.POSIXt(max(coronavirus$date), format = "%d/%m/%Y")`

```{r}
dfshow <- d.estado %>% 
  dplyr::group_by(state) %>% 
  dplyr::filter(date == max(date)) %>% 
  dplyr::ungroup() %>% 
  dplyr::arrange(-confirmed) %>%  
  dplyr::mutate(Confirmados = confirmed, 
                Mortes = deaths,
                pop = estimated_population_2019) %>% 
  dplyr::mutate(
    `Taxa de<br>Letalidade` = Mortes/Confirmados,
    `%C` = Confirmados/sum(Confirmados),
    `%M` = Mortes/sum(Mortes),
    con.pop = 1000000*(Confirmados / pop),
    mor.pop = 1000000*(Mortes / pop)
  ) %>% 
  dplyr::select("state", 
                "Confirmados", "%C", 
                "Mortes", "%M", "Taxa de<br>Letalidade",
                "pop", "con.pop", "mor.pop"
  )

names(dfshow)[1] <- " "
names(dfshow)[2] <- "Conf."
names(dfshow)[3] <- "% Conf."
names(dfshow)[4] <- "Mortes"
names(dfshow)[5] <- "% Mortes"
names(dfshow)[7] <- "Total<br>Populacional"
names(dfshow)[8] <- "Conf.<br>em 100k"
names(dfshow)[9] <- "Mortes<br>em 100k"

DT::datatable(dfshow, 
              options = list(
                columnDefs = list(list(className = 'dt-center', 
                                       targets = "_all")),
                lengthChange = FALSE,
                pageLength = 10
              ),
              escape = F
)%>%
  DT::formatPercentage(c(3, 5, 6), 
                       digits = 1
  ) %>% 
  DT::formatRound(c(8, 9), digits = 1)
  
```

> Legenda: 
Conf. = Confirmados,
% Conf. $= \frac{Confirmados}{Total(Confirmados)}$, 
% Mortes $= \frac{Mortes}{Total(Mortes)}$,
Taxa de Letalidade $= \frac{Mortes}{Confirmados}$,
Conf. em 100k = $100.000\frac{Confirmados}{Total Populacional}$,
Mortes em 100k = $100.000\frac{Mortes}{Total Populacional}$. <br>
Obs.: "Conf. em 100k" é o número de casos confirmados em 100.000 habitantes, dos quais "Mortes em 100k" foram a óbito. Por exemplo, em SP, `r round(dfshow[,8][dfshow[,1]=="SP"], 1)` a cada 100.000 foram confirmados, dos quais `r round(dfshow[,9][dfshow[,1]=="SP"], 1)` morreram.





Row {data-height=300}
-------------------------

### Em valores absolutos

```{r}
names(dfshow)[1] <- "state"

dfshow$state <- factor(dfshow$state, levels = dfshow$state)

plotly::plot_ly(data = dfshow, 
                x = ~ state, 
                y = ~ Conf., 
                type = "bar", 
                name = "Confirmados",
                marker = list(color = confirmed_colorT)) %>%
  plotly::add_trace(y = ~ Mortes, 
                    name = "Mortes",
                    marker = list(color = death_colorT)) %>%
  plotly::layout(barmode = 'group',
                 yaxis = list(title = "Número de casos"),
                 xaxis = list(title = ""),
                 legend = list(x = 0.8, y = 0.9),
                 hovermode = "compare")
```





Row {data-height=350}
-------------------------

### **<span style="color: #1478BE;">CONFIRMADOS</span>** em valores absolutos

```{r}
m <- 5
dfshow <- dfshow %>% 
  dplyr::arrange(-Conf.)

dfshow1 <- d.estado %>% 
  dplyr::filter(state %in% dfshow$state[1:m])%>% 
  dplyr::arrange(date)

dfshow1$state <- factor(dfshow1$state, levels = rev(dfshow$state[1:m]))

fig <- dfshow1 %>% 
  ggplot2::ggplot(ggplot2::aes(x = date, 
                               y = confirmed, 
                               fill = state)) +
  ggplot2::geom_area(alpha=0.7 , size=.7, colour="black") +
  viridis::scale_fill_viridis(discrete = T, name = " ", option = "B") +
  ggplot2::ylab("Frequência acumulada")+
  ggplot2::xlab("")+
  ggplot2::scale_y_continuous(labels = function(x) format(x, scientific = F))+
  ggplot2::theme_bw(base_size=20)+
  ggplot2::theme(panel.border     = ggplot2::element_blank(),
                 panel.background = ggplot2::element_blank(),
                 legend.position  = c(0.2, 0.65),
                 axis.text        = ggplot2::element_text(size=12),
                 axis.title       = ggplot2::element_text(size=15))
 
fig
```

### **<span style="color:#DC2828E6">MORTES</span>** em valores absolutos

```{r}
fig <- dfshow1 %>% 
  ggplot2::ggplot(ggplot2::aes(x = date, 
                               y = deaths, 
                               fill = state)) +
  ggplot2::geom_area(alpha=0.7 , size=.7, colour="black") +
  viridis::scale_fill_viridis(discrete = T, name = " ", option = "B") +
  ggplot2::ylab("")+
  ggplot2::xlab("")+
  ggplot2::scale_y_continuous(labels = function(x) format(x, scientific = F))+
  ggplot2::theme_bw(base_size=20)+
  ggplot2::theme(panel.border     = ggplot2::element_blank(),
                 panel.background = ggplot2::element_blank(),
                 legend.position  = c(0.2, 0.65),
                 axis.text        = ggplot2::element_text(size=12),
                 axis.title       = ggplot2::element_text(size=15))
 
fig
```





Row {data-height=300}
--------------------------------------------------------------------------------

### **Considerando o tamanho da população**

```{r}
names(dfshow)[8] <- "con.pop"
names(dfshow)[9] <- "mor.pop"

dfshow <- dfshow %>% 
  dplyr::arrange(-con.pop)

dfshow$state <- factor(dfshow$state, levels = dfshow$state)

plotly::plot_ly(data = dfshow, 
                x = ~ state, 
                y = ~ con.pop, 
                type = "bar", 
                name = "Confirmados",
                marker = list(color = confirmed_colorT)) %>%
  plotly::add_trace(y = ~ mor.pop, 
                    name = "Mortes",
                    marker = list(color = death_colorT)) %>%
  plotly::layout(barmode = 'group',
                 yaxis = list(title = "Nº de casos em 100.000 habitantes"),
                 xaxis = list(title = ""),
                 legend = list(x = 0.8, y = 0.9),
                 hovermode = "compare")
```





Mapa
================================================================================





### **Mapa mundi**

```{r}
library(leaflet)
library(leafpop)
library(purrr)
cv_data_for_plot <- coronavirus %>%
  dplyr::filter(cases > 0) %>%
  dplyr::group_by(Country.Region, Province.State, Lat, Long, type) %>%
  dplyr::summarise(cases = sum(cases)) %>%
  dplyr::mutate(log_cases = 2 * log(cases)) %>%
  dplyr::ungroup()
cv_data_for_plot.split <- cv_data_for_plot %>% split(cv_data_for_plot$type)
pal <- colorFactor(c("orange", "red", "green"), domain = c("confirmed", "death", "recovered"))
map_object <- leaflet() %>% addProviderTiles(providers$Stamen.Toner)
names(cv_data_for_plot.split) %>%
  purrr::walk(function(df) {
    map_object <<- map_object %>%
      addCircleMarkers(
        data = cv_data_for_plot.split[[df]],
        lng = ~Long, lat = ~Lat,
        #                 label=~as.character(cases),
        color = ~ pal(type),
        stroke = FALSE,
        fillOpacity = 0.8,
        radius = ~log_cases,
        popup = leafpop::popupTable(cv_data_for_plot.split[[df]],
                                    feature.id = FALSE,
                                    row.numbers = FALSE,
                                    zcol = c("type", "cases", "Country.Region", "Province.State")
        ),
        group = df,
        #                 clusterOptions = markerClusterOptions(removeOutsideVisibleBounds = F),
        labelOptions = labelOptions(
          noHide = F,
          direction = "auto"
        )
      )
  })
map_object %>%
  addLayersControl(
    overlayGroups = names(cv_data_for_plot.split),
    options = layersControlOptions(collapsed = FALSE)
  )
```





Mais
================================================================================

Para visualizações interativas acesse https://grequena.shinyapps.io/coronavirusBR





Sobre
================================================================================

**Dashboard para acompanhamento dos casos de COVID-19 no Brasil**

Essa dashboard fornece uma descrição estatística sobre a evolução de casos do Novo Coronavírus (COVID-19) no Brasil e no mundo.

Sua construção foi feita no R através do R Markdown por meio do pacote [`flexdashboard`](https://rmarkdown.rstudio.com/flexdashboard/){target="_blank"}.

Sua primeira versão é uma adaptação dessa [dashboard](https://ramikrispin.github.io/coronavirus_dashboard/){target="_blank"} por Rami Krispin.

**Código**

O código-fonte pode ser acessado no canto superior direito no botão `</> Source Code`.

**Dados**

Os bancos de dados utilizados são fornecidos pela Johns Hopkins University Center for Systems Science and Engineering (JHU CCSE), mantidos neste [repositório](https://github.com/CSSEGISandData/COVID-19) do github.
O portal oficial do Ministério da Saúde com os números de casos confirmados e óbitos no Brasil pode ser visto [aqui](https://covid.saude.gov.br/).

Os dados sobre o tamanho da população podem ser acessados no site do Banco Mundial [aqui](https://data.worldbank.org/indicator/SP.POP.TOTL).

Para os dados específicos por unidade federativa no Brasil, a fonte é a plataforma https://brasil.io.

**Contato**

Para quaisquer dúvidas ou sugestões, você pode nos contatar através do e-mail requena@ufv.br.

**Atualização**

Última atualização:  `r as.character.POSIXt(Sys.time(), 
format = "%d/%m/%Y")`.
